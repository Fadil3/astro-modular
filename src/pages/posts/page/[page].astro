---
import { siteConfig } from '@/config';
import BaseLayout from '@/layouts/BaseLayout.astro';
import StrapiPostCard from '@/components/StrapiPostCard.astro';
import Tags from '@/components/Tags.astro';
import Pagination from '@/components/Pagination.astro';
import Icon from '@/components/Icon.astro';
import { fetchStrapiPosts } from '@/utils/strapi';

// Enable server-side rendering for Strapi pagination
export const prerender = false;

const { page } = Astro.params;
if (import.meta.env.DEV) {
  console.log('[page].astro (new) - Received page:', page);
  console.log('[page].astro (new) - Astro.url.pathname:', Astro.url.pathname);
}
const url = new URL(Astro.request.url);
const selectedTag = url.searchParams.get('tag') || undefined;
const currentPage = Math.max(1, parseInt(page || '2', 10) || 2);
if (import.meta.env.DEV) {
  console.log('[page].astro (new) - Parsed currentPage:', currentPage);
}
const postsPerPage = siteConfig.postOptions.postsPerPage;
const locale = siteConfig.language || 'en';

const { items, meta } = await fetchStrapiPosts({ page: currentPage, pageSize: postsPerPage, tag: selectedTag, locale });
const totalPages = meta.pagination?.pageCount ?? currentPage;

const tagSet = new Set<string>();
items.forEach(p => (p.tags || []).forEach(t => tagSet.add(t)));
const allTags = Array.from(tagSet).sort((a, b) => a.localeCompare(b));

// Generate SEO data
const pageTitle = selectedTag
  ? `Posts tagged "${selectedTag}" - Page ${currentPage}`
  : `All Posts - Page ${currentPage}`;
const pageDescription = selectedTag
  ? `All posts tagged with "${selectedTag}"`
  : `Browse posts on ${siteConfig.title}`;
const seoData = { title: `${pageTitle} | ${siteConfig.title}`, description: pageDescription, canonical: Astro.url.href, ogType: 'website' as const };

const firstPageUrl = selectedTag ? `/posts?tag=${encodeURIComponent(selectedTag)}` : '/posts';
const baseUrl = '/posts/page';
const queryString = selectedTag ? `?tag=${encodeURIComponent(selectedTag)}` : '';
const pagination = {
  currentPage,
  totalPages,
  hasNext: currentPage < totalPages,
  hasPrev: currentPage > 1,
} as const;
---

<BaseLayout seoData={seoData}>
  <Fragment slot="head" />

  <div class="py-8 relative">
    <div class="mx-auto px-4 sm:px-6 lg:px-8 mb-12" style={`max-width: ${siteConfig.layout.contentWidth}`}>
      <!-- Header -->
      <header class="mb-8">
        <div class="flex items-start justify-between mb-3">
          <h1 class="text-lg font-bold text-primary-900 dark:text-primary-50">
            {pageTitle}
          </h1>
        </div>
        <p class="text-base text-primary-600 dark:text-primary-300">
          {selectedTag ? (
            <>
              Showing <strong>{items.length}</strong> posts tagged with 
              <span class="inline-flex items-center px-2 py-1 bg-highlight-100 dark:bg-highlight-900/30 text-highlight-800 dark:text-highlight-200 rounded text-sm font-medium ml-1">
                #{selectedTag}
              </span>
            </>
          ) : (
            <>Page {currentPage} of {totalPages}</>
          )}
        </p>

        {selectedTag && (
          <div class="mt-4">
            <a 
              href="/posts"
              class="inline-flex items-center text-sm text-primary-600 dark:text-primary-300 hover:text-primary-800 dark:hover:text-primary-200 transition-colors"
            >
              <Icon name="arrow-left" class="w-4 h-4 mr-1" />
              Show all posts
            </a>
          </div>
        )}
      </header>

      <div class="relative">
        <!-- Main content -->
        <div class="max-w-none">
          {items.length > 0 ? (
            <>
              <!-- Posts list -->
              <div class="space-y-4 mb-12">
                {items.map((post, index) => (
                  <StrapiPostCard post={post} eager={index === 0} context="posts" />
                ))}
              </div>

              <!-- Pagination -->
              <Pagination pagination={pagination} baseUrl={baseUrl} firstPageUrl={firstPageUrl} queryString={queryString} />
            </>
          ) : (
            <div class="text-center py-16">
              <Icon name="file-text" class="w-16 h-16 text-primary-400 dark:text-primary-500 mx-auto mb-6" />
              <h2 class="text-2xl font-semibold text-primary-900 dark:text-primary-50 mb-4">
                No posts found on this page
              </h2>
              <p class="text-primary-600 dark:text-primary-300 mb-8">
                Try going back to an earlier page or removing filters.
              </p>
            </div>
          )}
        </div>

        <!-- Mobile sidebar -->
        <div class="xl:hidden mt-12 space-y-6">
          {siteConfig.postOptions.tags && allTags.length > 0 && (
            <Tags tags={allTags} />
          )}
        </div>

        <!-- Desktop sidebar -->
        <div class="hidden xl:block absolute top-0 left-full ml-8 w-64">
          <div class="sticky top-24 space-y-3 max-h-[calc(100vh-12rem)] overflow-y-auto pb-6">
            {siteConfig.postOptions.tags && allTags.length > 0 && (
              <Tags tags={allTags} />
            )}
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>
