---
import { getEntry } from 'astro:content';
import { siteConfig } from '@/config';
import { generatePostsListSEO } from '@/utils/seo';
import { fetchStrapiProjects } from '@/utils/strapi';
import BaseLayout from '@/layouts/BaseLayout.astro';
import PageLayout from '@/layouts/PageLayout.astro';
import StrapiProjectCard from '@/components/StrapiProjectCard.astro';
import Icon from '@/components/Icon.astro';

export const prerender = false;

// Check if projects are enabled and handle fallback
let fallbackPage = null;

if (!siteConfig.optionalContentTypes.projects) {
  // Check for fallback page in pages collection
  try {
    fallbackPage = await getEntry('pages', 'projects');
    if (fallbackPage) {
      // PageLayout will handle the rendering
    } else {
      return Astro.redirect('/404');
    }
  } catch (error) {
    // No fallback page found, redirect to 404
    return Astro.redirect('/404');
  }
}

// Get all projects from Strapi
const locale = Astro.currentLocale || 'en';
const allProjects = await fetchStrapiProjects({ locale });

// Extract unique categories from projects
const allCategories = Array.from(new Set(allProjects.flatMap(p => p.categories))).sort();
const projectsHaveCategories = allCategories.length > 0;

// Get projects page content from special collection
let projectsPageContent = null;
let ProjectsPageContent = null;

try {
  projectsPageContent = await getEntry('special', 'projects');
  if (projectsPageContent) {
    const { Content } = await projectsPageContent.render();
    ProjectsPageContent = Content;
  }
} catch (error) {
  // Fallback to default if projects.md doesn't exist
}

// Generate SEO data
const seoData = generatePostsListSEO(Astro.site?.toString() || '', undefined);
seoData.title = projectsPageContent?.data.title ? `${projectsPageContent.data.title} | ${siteConfig.title}` : `Projects | ${siteConfig.title}`;
seoData.description = projectsPageContent?.data.description || `Browse all projects on ${siteConfig.title}`;
seoData.noIndex = (projectsPageContent?.data as any)?.noIndex || false;
---

{fallbackPage ? (
  <PageLayout page={fallbackPage as any} />
) : (
<BaseLayout seoData={seoData}>
  <div class="py-8 relative">
    <div class="mx-auto px-4 sm:px-6 lg:px-8 mb-12" style={`max-width: ${siteConfig.layout.contentWidth}`}>
      <!-- Page header -->
      <header class="mb-8">
        <h1 class="text-lg font-bold text-primary-900 dark:text-primary-50 mb-3">
          {projectsPageContent?.data.title || 'Projects'}
        </h1>
        {ProjectsPageContent ? (
          <div class="prose prose-sm dark:prose-dark max-w-none">
            <ProjectsPageContent />
          </div>
        ) : (
          <p class="text-primary-600 dark:text-primary-300">
            A collection of my work and side projects
          </p>
        )}
      </header>

      <div class="relative">
        <!-- Main content -->
        <div class="max-w-none">
          {allProjects.length > 0 ? (
            <>
              <!-- Projects grid -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
            {allProjects.map((project, index) => (
              <StrapiProjectCard 
                project={project} 
                eager={index === 0}
              />
            ))}
              </div>
            </>
          ) : (
            <div class="text-center py-12">
              <Icon name="folder-open" class="w-12 h-12 text-primary-300 dark:text-primary-600 mx-auto mb-4" />
              <h3 class="text-lg font-medium text-primary-900 dark:text-primary-50 mb-2">
                No projects yet
              </h3>
              <p class="text-primary-600 dark:text-primary-300">
                Check back soon for new projects!
              </p>
            </div>
          )}
        </div>

        <!-- Mobile sidebar - appears below content on mobile/tablet -->
        <div class="xl:hidden mt-12 space-y-6">
          <!-- Categories -->
          {projectsHaveCategories && allCategories.length > 0 && (
            <div class="bg-primary-50 dark:bg-primary-900 rounded-lg border border-primary-200 dark:border-primary-700 shadow-sm p-6">
              <h3 class="text-base font-semibold text-primary-900 dark:text-primary-50 mb-4">Categories</h3>
              <div class="flex flex-wrap gap-2">
                {allCategories.map((category) => (
                  <span class="text-xs text-primary-600 dark:text-primary-300 bg-primary-100 dark:bg-primary-800 px-2.5 py-1 rounded-full border border-primary-200 dark:border-primary-700">
                    {category}
                  </span>
                ))}
              </div>
            </div>
          )}
        </div>

        <!-- Desktop sidebar - floats to the right of the content container -->
        <div class="hidden xl:block absolute top-0 left-full ml-8 w-64">
          <div class="sticky top-24 space-y-3 max-h-[calc(100vh-12rem)] overflow-y-auto pb-6">
            <!-- Categories -->
            {projectsHaveCategories && allCategories.length > 0 && (
              <div class="bg-primary-50 dark:bg-primary-900 rounded-lg border border-primary-200 dark:border-primary-700 shadow-sm p-6">
                <h3 class="text-base font-semibold text-primary-900 dark:text-primary-50 mb-4">Categories</h3>
                <div class="flex flex-wrap gap-2">
                  {allCategories.map((category) => (
                    <span class="text-xs text-primary-600 dark:text-primary-300 bg-primary-100 dark:bg-primary-800 px-2.5 py-1 rounded-full border border-primary-200 dark:border-primary-700">
                      {category}
                    </span>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>
)}
