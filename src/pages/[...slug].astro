---
import { getCollection } from 'astro:content';
import { siteConfig } from '@/config';
import PageLayout from '@/layouts/PageLayout.astro';
import { fetchStrapiPageBySlug } from '@/utils/strapi';
import StrapiPageLayout from '@/layouts/StrapiPageLayout.astro';

export const prerender = false;

// Handle redirects for old tag routes
const { slug } = Astro.params;
if (typeof slug === 'string' && slug.startsWith('posts/tag/')) {
  const tagName = slug.replace('posts/tag/', '');
  return Astro.redirect(`/posts?tag=${encodeURIComponent(tagName)}`);
}

// Ensure we have a slug string
if (typeof slug !== 'string' || !slug) {
  return Astro.redirect('/404');
}

const locale = Astro.currentLocale || 'en';

// 1) Try Strapi Pages first (so /about resolves to Strapi without needing /page/about)
const strapiPage = await fetchStrapiPageBySlug(slug, locale);
if (strapiPage) {
  // Render Strapi-backed page
  const page = strapiPage;
  return await Astro.render(StrapiPageLayout, { page });
}

// 2) Fallback to content collections for legacy/special pages
// Special pages that act as fallbacks when optional content types are disabled
if (slug === 'projects' && !siteConfig.optionalContentTypes.projects) {
  const special = await getCollection('special');
  const specialPage = special.find((p) => p.slug === 'projects');
  if (specialPage) {
    return await Astro.render(PageLayout, { page: specialPage });
  }
}

if (slug === 'docs' && !siteConfig.optionalContentTypes.docs) {
  const special = await getCollection('special');
  const specialPage = special.find((p) => p.slug === 'docs');
  if (specialPage) {
    return await Astro.render(PageLayout, { page: specialPage });
  }
}

// Regular content pages (legacy file-based pages)
const pages = await getCollection('pages');
const contentPage = pages.find((p) => p.slug === slug);
if (contentPage) {
  // In production, hide drafts
  const isDev = import.meta.env.DEV;
  if (!isDev && contentPage.data.draft) {
    return Astro.redirect('/404');
  }
  return await Astro.render(PageLayout, { page: contentPage });
}

// Nothing matched
return Astro.redirect('/404');
---
