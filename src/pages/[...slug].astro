---
import { getCollection } from 'astro:content';
import { siteConfig } from '@/config';
import PageLayout from '@/layouts/PageLayout.astro';
import { fetchStrapiPageBySlug } from '@/utils/strapi';
import StrapiPageLayout from '@/layouts/StrapiPageLayout.astro';

export const prerender = false;

// Handle redirects for old tag routes
const { slug } = Astro.params;
if (typeof slug === 'string' && slug.startsWith('posts/tag/')) {
  const tagName = slug.replace('posts/tag/', '');
  return Astro.redirect(`/posts?tag=${encodeURIComponent(tagName)}`);
}

// Ensure we have a slug string
if (typeof slug !== 'string' || !slug) {
  return Astro.redirect('/404');
}

const locale = Astro.currentLocale || 'en';

// 1) Try Strapi Pages first (so /about resolves to Strapi without needing /page/about)
const strapiPage = await fetchStrapiPageBySlug(slug, locale);

// Prepare fallbacks only if no Strapi page
let specialPage = null;
let contentPage = null;

if (!strapiPage) {
  // 2) Fallback to content collections for legacy/special pages
  if (slug === 'projects' && !siteConfig.optionalContentTypes.projects) {
    const special = await getCollection('special');
    specialPage = special.find((p) => p.slug === 'projects') || null;
  } else if (slug === 'docs' && !siteConfig.optionalContentTypes.docs) {
    const special = await getCollection('special');
    specialPage = special.find((p) => p.slug === 'docs') || null;
  } else {
    // Regular content pages (legacy file-based pages)
    const pages = await getCollection('pages');
    const candidate = pages.find((p) => p.slug === slug) || null;
    if (candidate) {
      const isDev = import.meta.env.DEV;
      if (!isDev && candidate.data.draft) {
        // Drafts not visible in production
        // Fall through to 404 handled after frontmatter
      } else {
        contentPage = candidate;
      }
    }
  }
}

// If nothing matched, redirect to 404 here to avoid rendering below
if (!strapiPage && !specialPage && !contentPage) {
  return Astro.redirect('/404');
}
---
{strapiPage && (<StrapiPageLayout page={strapiPage} />)}
{!strapiPage && specialPage && (<PageLayout page={specialPage} />)}
{!strapiPage && !specialPage && contentPage && (<PageLayout page={contentPage} />)}
