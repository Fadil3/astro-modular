---
import { siteConfig, getPostCardAspectRatio } from '@/config';

interface Props {
  post: {
    slug: string;
    title: string;
    date: Date;
    imageUrl?: string;
    tags: string[];
    excerpt?: string;
  };
  featured?: boolean;
  eager?: boolean;
  context?: 'featured' | 'recent' | 'posts' | 'tags';
}

const { post, featured = false, eager = false, context = 'posts' } = Astro.props as Props;

const shouldShowCoverImage = (() => {
  if (!post.imageUrl) return false;
  const showCoverImages = siteConfig.postOptions.showPostCardCoverImages;
  switch (showCoverImages) {
    case 'all':
      return true;
    case 'featured':
      return context === 'featured' || featured;
    case 'home':
      return context === 'featured' || context === 'recent';
    case 'posts':
      return context === 'posts' || context === 'tags';
    case 'featured-and-posts':
      return context === 'featured' || context === 'posts' || context === 'tags' || featured;
    case 'none':
    default:
      return false;
  }
})();
---

<article class={`group ${featured ? 'featured-post' : 'post-card'}`} role="article" aria-labelledby={`post-title-${post.slug}`}>
  <a href={`/post/${post.slug}`} class="block" aria-label={`View post: ${post.title}`}>
    {post.imageUrl && shouldShowCoverImage && (
      <div class="overflow-hidden rounded-t-lg bg-primary-100 dark:bg-primary-800" style={`aspect-ratio: ${getPostCardAspectRatio()};`}>
        <img 
          src={post.imageUrl}
          alt={`Featured image for post: ${post.title}`}
          class="w-full h-full object-cover group-hover:scale-102 transition-all duration-300"
          width="800"
          height="450"
          loading={featured || eager ? 'eager' : 'lazy'}
          fetchpriority={featured || eager ? 'high' : 'auto'}
          decoding="async"
        />
      </div>
    )}

    <div class={`p-4 ${post.imageUrl && shouldShowCoverImage ? 'rounded-b-lg' : 'rounded-lg'}`}>
      <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-sm text-primary-500 dark:text-primary-400 mb-1">
        <time datetime={post.date.toISOString()}>{post.date.toLocaleDateString()}</time>
      </div>

      <h3 id={`post-title-${post.slug}`} class={`font-medium text-primary-900 dark:text-primary-100 leading-relaxed group-hover:text-highlight-600 dark:group-hover:text-highlight-400 transition-colors ${featured ? 'text-lg' : 'text-base'}`}>
        {post.title}
      </h3>

      {featured && post.excerpt && (
        <p class="text-primary-600 dark:text-primary-300 line-clamp-3 text-sm leading-relaxed mt-1">
          {post.excerpt}
        </p>
      )}

      {post.tags && post.tags.length > 0 && siteConfig.postOptions.tags && (
        <div class="mt-3">
          {post.tags.slice(0, 3).map((tag) => (
            <a
              href={`/posts?tag=${encodeURIComponent(tag)}`}
              class="inline-block text-xs text-primary-600 dark:text-primary-300 bg-primary-100 dark:bg-primary-800 px-2.5 py-1 rounded-full border border-primary-200 dark:border-primary-700 transition-colors hover:bg-highlight-100 dark:hover:bg-highlight-800 mr-2 mb-1"
              aria-label={`View posts tagged with ${tag}`}
            >
              {tag}
            </a>
          ))}
          {post.tags.length > 3 && (
            <span class="inline-block text-xs text-primary-500 dark:text-primary-400 bg-primary-50 dark:bg-primary-800 px-2.5 py-1 rounded-full border border-primary-200 dark:border-primary-700 mr-2 mb-1">
              + {post.tags.length - 3} more
            </span>
          )}
        </div>
      )}
    </div>
  </a>
</article>
