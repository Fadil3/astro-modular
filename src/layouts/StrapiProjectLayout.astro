---
import { siteConfig } from '@/config';
import BaseLayout from '@/layouts/BaseLayout.astro';
import Icon from '@/components/Icon.astro';

interface Props {
  project: {
    slug: string;
    title: string;
    description?: string;
    date: Date;
    imageUrl?: string;
    categories: string[];
    repositoryUrl?: string;
    demoUrl?: string;
    status?: string;
    html?: string;
  };
}

const { project } = Astro.props as Props;

const seoData = {
  title: `${project.title} | ${siteConfig.title}`,
  description: project.description,
  canonical: Astro.url.href,
  ogType: 'website' as const
};

// Normalize status for display
const displayStatus = project.status ? 
  project.status.toLowerCase() === 'in-progress' || project.status.toLowerCase() === 'in progress' ? 'In Progress' :
  project.status.toLowerCase() === 'completed' ? 'Completed' :
  project.status : undefined;
---

<BaseLayout seoData={seoData}>
  <div class="py-8 relative">
    <div class="mx-auto px-4 sm:px-6 lg:px-8 relative" style={`max-width: ${siteConfig.layout.contentWidth}`}>
      <article class={`bg-primary-50 dark:bg-primary-900 rounded-lg border border-primary-200 dark:border-primary-700 shadow-sm ${project.imageUrl ? 'overflow-hidden' : ''}`}>
        {project.imageUrl && (
          <div class="h-40 sm:h-48 md:h-56 lg:h-64 overflow-hidden rounded-t-lg bg-primary-100 dark:bg-primary-800">
            <img src={project.imageUrl} alt={`Featured image for project: ${project.title}`} class="w-full h-full object-cover" width="800" height="256" loading="eager" fetchpriority="high" decoding="async" />
          </div>
        )}

        <div class={`p-6 ${project.imageUrl ? 'rounded-b-lg' : 'rounded-lg'}`}>
          <header class="mb-4">
            <h1 class="text-xl font-bold text-primary-900 dark:text-primary-50 mb-6 leading-tight">{project.title}</h1>
            
            <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm text-primary-600 dark:text-primary-300 mb-6">
              <time datetime={project.date.toISOString()} class="font-medium">{project.date.toLocaleDateString()}</time>
              {displayStatus && (
                <span class={`px-2.5 py-1 rounded-full text-xs font-medium ${
                  displayStatus === 'Completed' 
                    ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 border border-green-200 dark:border-green-700'
                    : displayStatus === 'In Progress'
                    ? 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 border border-yellow-200 dark:border-yellow-700'
                    : 'bg-primary-100 dark:bg-primary-800 text-primary-700 dark:text-primary-200 border border-primary-200 dark:border-primary-700'
                }`}>
                  {displayStatus}
                </span>
              )}
            </div>

            {project.categories && project.categories.length > 0 && (
              <div class="flex flex-wrap gap-2 mb-6">
                {project.categories.map(category => (
                  <span class="text-xs text-primary-600 dark:text-primary-300 bg-primary-100 dark:bg-primary-800 px-2.5 py-1 rounded-full border border-primary-200 dark:border-primary-700">{category}</span>
                ))}
              </div>
            )}

            {(project.repositoryUrl || project.demoUrl) && (
              <div class="flex flex-wrap gap-3 mb-6">
                {project.repositoryUrl && (
                  <a href={project.repositoryUrl} target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-sm text-highlight-600 dark:text-highlight-400 hover:text-highlight-700 dark:hover:text-highlight-300 font-medium transition-colors">
                    <Icon name="github" class="w-4 h-4" />
                    Repository
                  </a>
                )}
                {project.demoUrl && (
                  <a href={project.demoUrl} target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-sm text-highlight-600 dark:text-highlight-400 hover:text-highlight-700 dark:hover:text-highlight-300 font-medium transition-colors">
                    <Icon name="external-link" class="w-4 h-4" />
                    Live Demo
                  </a>
                )}
              </div>
            )}
          </header>

          <div class="prose dark:prose-dark max-w-none" id="project-content" set:html={project.html || ''} />
        </div>
      </article>
    </div>
  </div>

  <Fragment slot="scripts">
    <script>
      // Open external links in a new tab
      function processExternalLinks() {
        const allLinks = document.querySelectorAll('.prose a[href]');
        allLinks.forEach(link => {
          const href = link.getAttribute('href');
          if (href && (href.startsWith('http://') || href.startsWith('https://'))) {
            if (!link.hasAttribute('target')) {
              link.setAttribute('target', '_blank');
              link.setAttribute('rel', 'noopener noreferrer');
            }
          }
        });
      }
      document.addEventListener('DOMContentLoaded', processExternalLinks);
      document.addEventListener('swup:contentReplaced', () => setTimeout(processExternalLinks, 100));
    </script>
  </Fragment>
</BaseLayout>
